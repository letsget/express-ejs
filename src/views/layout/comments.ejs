<!-- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (–≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ include) -->
<div class="comments-section mt-5 pt-4 border-top">
    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
    <div class="comment-form card mb-4">
        <div class="card-body">
            <h3 class="card-title mb-4">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h3>

            <form id="commentForm">
                <div class="mb-3">
                    <label for="commentUsername" class="form-label">–í–∞—à–µ –∏–º—è</label>
                    <input type="text"
                           class="form-control"
                           id="commentUsername"
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è"
                           required>
                </div>

                <div class="mb-3">
                    <label for="commentText" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    <textarea class="form-control"
                              id="commentText"
                              rows="3"
                              placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."
                              required></textarea>
                </div>

                <button type="submit" class="btn btn-primary">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                </button>
            </form>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
    <div class="comments-list">
        <h4 class="mb-3 d-flex align-items-center">
            –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
            <span class="badge bg-secondary ms-2" id="commentsCount">0</span>
        </h4>

        <div id="commentsContainer">
            <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            <% if (comments && comments.length > 0) { %>
                <% comments.forEach(function(comment) { %>
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-subtitle mb-1 text-primary">
                                    <%= comment.username %>
                                </h6>
                                <small class="text-muted">
                                    <%= comment.timestamp ? new Date(comment.timestamp).toLocaleString('ru-RU') : '–¢–æ–ª—å–∫–æ —á—Ç–æ' %>
                                </small>
                            </div>
                            <p class="card-text mb-0"><%= comment.text %></p>
                        </div>
                    </div>
                <% }); %>
            <% } else { %>
                <div class="alert alert-info">
                    –ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!
                </div>
            <% } %>
        </div>
    </div>
</div>

<!-- Socket.io —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
<script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è bookId –∏–∑ URL
    function getBookIdFromUrl() {
        const path = window.location.pathname;
        const match = path.match(/\/books\/(\d+)/);
        return match ? match[1] : 'default';
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    function initComments() {
        console.log('‚úÖ Socket.io –¥–æ—Å—Ç—É–ø–µ–Ω!');

        const bookId = getBookIdFromUrl();
        console.log('üìñ Book ID:', bookId);

        const socket = io({
            query: { bookId: bookId }
        });

        const commentForm = document.getElementById('commentForm');
        const usernameInput = document.getElementById('commentUsername');
        const commentInput = document.getElementById('commentText');
        const commentsContainer = document.getElementById('commentsContainer');
        const commentsCount = document.getElementById('commentsCount');

        // –û—Ç–ª–∞–¥–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        socket.on('connect', () => {
            console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å–µ—Ä–≤–µ—Ä—É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, Socket ID:', socket.id);
        });

        socket.on('disconnect', () => {
            console.log('üîå –û—Ç–∫–ª—é—á–µ–Ω –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
        });

        socket.on('connect_error', (error) => {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
        });

        // –°–æ–∑–¥–∞–Ω–∏–µ HTML –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
        function createCommentElement(comment) {
            const div = document.createElement('div');
            div.className = 'card mb-3';

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –º–æ–π –ª–∏ —ç—Ç–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            const isMyComment = comment.socketId === socket.id;
            if (isMyComment) {
                div.classList.add('border-primary', 'border-2');
            }

            div.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-subtitle mb-1 text-primary">
                            ${escapeHtml(comment.username)}
                            ${isMyComment ? '<span class="badge bg-info ms-2">–í—ã</span>' : ''}
                        </h6>
                        <small class="text-muted">
                            ${comment.timestamp ? new Date(comment.timestamp).toLocaleString('ru-RU') : '–¢–æ–ª—å–∫–æ —á—Ç–æ'}
                        </small>
                    </div>
                    <p class="card-text mb-0">${escapeHtml(comment.text)}</p>
                </div>
            `;
            return div;
        }

        // –ó–∞—â–∏—Ç–∞ –æ—Ç XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –≤ —Å–ø–∏—Å–æ–∫
        function addCommentToUI(comment) {
            console.log('‚ûï –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ UI:', comment.username);

            if (!commentsContainer) {
                console.error('‚ùå commentsContainer –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }

            const commentElement = createCommentElement(comment);

            // –£–±–∏—Ä–∞–µ–º –∞–ª–µ—Ä—Ç "–Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤" –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            const alertElement = commentsContainer.querySelector('.alert');
            if (alertElement) {
                commentsContainer.removeChild(alertElement);
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
            commentsContainer.insertBefore(commentElement, commentsContainer.firstChild);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            if (commentsCount) {
                const currentCount = parseInt(commentsCount.textContent) || 0;
                commentsCount.textContent = currentCount + 1;
            }

            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
            commentElement.style.opacity = '0';
            commentElement.style.transform = 'translateY(-10px)';

            setTimeout(() => {
                commentElement.style.transition = 'all 0.3s ease';
                commentElement.style.opacity = '1';
                commentElement.style.transform = 'translateY(0)';
            }, 10);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        if (commentForm) {
            commentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('üìù –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã...');

                const username = usernameInput.value.trim();
                const text = commentInput.value.trim();

                if (!username || !text) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                    return;
                }

                console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:', { username, text, bookId });

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                socket.emit('add-new-comment', {
                    username: username,
                    text: text,
                    bookId: bookId
                });

                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
                commentInput.value = '';
                commentInput.focus();

                console.log('‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
            });
        }

        // ============ –°–û–ë–´–¢–ò–Ø –û–¢ –°–ï–†–í–ï–†–ê ============

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
        socket.on('load-all-comments', function(comments) {
            console.log('üì• –ü–æ–ª—É—á–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:', comments.length, '—à—Ç.');

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            if (commentsCount) {
                commentsCount.textContent = comments.length;
            }

            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            if (commentsContainer) {
                commentsContainer.innerHTML = '';

                // –ï—Å–ª–∏ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–ª–µ—Ä—Ç
                if (comments.length === 0) {
                    commentsContainer.innerHTML = '<div class="alert alert-info">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>';
                    return;
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                comments.forEach(comment => {
                    const element = createCommentElement(comment);
                    commentsContainer.appendChild(element);
                });
            }
        });

        // ‚òÖ‚òÖ‚òÖ –ï–î–ò–ù–û–ï –°–û–ë–´–¢–ò–ï –î–õ–Ø –í–°–ï–• –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ï–í ‚òÖ‚òÖ‚òÖ
        socket.on('new-comment', function(comment) {
            console.log('üí¨ –ü–æ–ª—É—á–µ–Ω –Ω–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:', comment);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è —ç—Ç–æ–π –∫–Ω–∏–≥–∏
            if (comment.bookId === bookId || comment.bookId === String(bookId)) {
                console.log('‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ UI');
                addCommentToUI(comment);
            } else {
                console.log('‚ùå –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –¥—Ä—É–≥–æ–π –∫–Ω–∏–≥–∏, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º');
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
        socket.on('error', function(error) {
            console.error('‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', error);
            alert('–û—à–∏–±–∫–∞: ' + error);
        });

        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
        console.log('üîÑ –ó–∞–ø—Ä–∞—à–∏–≤–∞—é –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏...');
        socket.emit('request-comments');

        // –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        socket.onAny((eventName, ...args) => {
            console.log(`üéØ –°–æ–±—ã—Ç–∏–µ "${eventName}":`, args.length > 0 ? args[0] : '–±–µ–∑ –¥–∞–Ω–Ω—ã—Ö');
        });
    }

    // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initComments);
    } else {
        initComments();
    }
</script>