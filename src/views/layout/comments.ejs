<div class="comments-section mt-5 pt-4 border-top">
    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
    <div class="comment-form card mb-4">
        <div class="card-body">
            <h3 class="card-title mb-4">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h3>

            <form id="commentForm">
                <div class="mb-3">
                    <label for="commentUsername" class="form-label">–í–∞—à–µ –∏–º—è</label>
                    <input type="text"
                           class="form-control"
                           id="commentUsername"
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è"
                           required>
                </div>

                <div class="mb-3">
                    <label for="commentText" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    <textarea class="form-control"
                              id="commentText"
                              rows="3"
                              placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."
                              required></textarea>
                </div>

                <button type="submit" class="btn btn-primary">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                </button>
            </form>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
    <div class="comments-list">
        <h4 class="mb-3 d-flex align-items-center">
            –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
            <span class="badge bg-secondary ms-2" id="commentsCount">0</span>
        </h4>

        <div id="commentsContainer">
            <% if (comments && comments.length > 0) { %>
                <% comments.forEach(function(comment) { %>
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-subtitle mb-1 text-primary">
                                    <%= comment.username %>
                                </h6>
                                <small class="text-muted">
                                    <%= comment.timestamp ? new Date(comment.timestamp).toLocaleString('ru-RU') : '–¢–æ–ª—å–∫–æ —á—Ç–æ' %>
                                </small>
                            </div>
                            <p class="card-text mb-0"><%= comment.text %></p>
                        </div>
                    </div>
                <% }); %>
            <% } else { %>
                <div class="alert alert-info">
                    –ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!
                </div>
            <% } %>
        </div>
    </div>
</div>

<!-- Socket.io —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
<script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è bookId –∏–∑ URL
    function getBookIdFromUrl() {
        const path = window.location.pathname;
        const match = path.match(/\/books\/(\d+)/);
        return match[1];
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    function initComments() {
        console.log('‚úÖ Socket.io –¥–æ—Å—Ç—É–ø–µ–Ω!');

        const bookId = getBookIdFromUrl();
        console.log('üìñ Book ID:', bookId);

        const socket = io({
            query: { bookId: bookId }
        });

        const commentForm = document.getElementById('commentForm');
        const usernameInput = document.getElementById('commentUsername');
        const commentInput = document.getElementById('commentText');
        const commentsContainer = document.getElementById('commentsContainer');
        const commentsCount = document.getElementById('commentsCount');

        // –°–æ–∑–¥–∞–Ω–∏–µ HTML –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
        function createCommentElement(comment) {
            const div = document.createElement('div');
            div.className = 'card mb-3';

            const isMyComment = comment.socketId === socket.id;
            if (isMyComment) {
                div.classList.add('border-primary', 'border-2');
            }

            div.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-subtitle mb-1 text-primary">
                            ${escapeHtml(comment.username)}
                            ${isMyComment ? '<span class="badge bg-info ms-2">–í—ã</span>' : ''}
                        </h6>
                        <small class="text-muted">
                            ${comment.timestamp ? new Date(comment.timestamp).toLocaleString('ru-RU') : '–¢–æ–ª—å–∫–æ —á—Ç–æ'}
                        </small>
                    </div>
                    <p class="card-text mb-0">${escapeHtml(comment.text)}</p>
                </div>
            `;
            return div;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function addCommentToUI(comment) {
            const noCommentsAlert = commentsContainer.querySelector('.alert-info');
            // –≠—Ç–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å "–Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤" —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏
            if (noCommentsAlert) {
                noCommentsAlert.remove();
            }

            const commentElement = createCommentElement(comment);
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
            commentsContainer.insertBefore(commentElement, commentsContainer.firstChild);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            if (commentsCount) {
                const currentCount = parseInt(commentsCount.textContent) || 0;
                commentsCount.textContent = currentCount + 1;
            }

            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
            commentElement.style.opacity = '0';
            commentElement.style.transform = 'translateY(-10px)';

            setTimeout(() => {
                commentElement.style.transition = 'all 0.3s ease';
                commentElement.style.opacity = '1';
                commentElement.style.transform = 'translateY(0)';
            }, 10);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        if (commentForm) {
            commentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const username = usernameInput.value.trim();
                const text = commentInput.value.trim();

                if (!username || !text) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                    return;
                }

                socket.emit('add-new-comment', {
                    username: username,
                    text: text,
                    bookId: bookId
                });

                commentInput.value = '';
                commentInput.focus();
            });
        }

        // ============ –°–û–ë–´–¢–ò–Ø –û–¢ –°–ï–†–í–ï–†–ê ============

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
        socket.on('load-all-comments', function(comments) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            if (commentsCount) {
                commentsCount.textContent = comments.length;
            }
            console.log('comments from load-all-comments socket', comments)
            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            if (commentsContainer) {
                console.log('commentsContainer if gotten');
                commentsContainer.innerHTML = '';

                if (comments.length === 0) {
                    commentsContainer.innerHTML = '<div class="alert alert-info">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>';
                    return;
                }

                comments.forEach(comment => {
                    const element = createCommentElement(comment);
                    commentsContainer.appendChild(element);
                });
            }
        });

        // ‚òÖ‚òÖ‚òÖ –ï–î–ò–ù–û–ï –°–û–ë–´–¢–ò–ï –î–õ–Ø –í–°–ï–• –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ï–í ‚òÖ‚òÖ‚òÖ
        socket.on('new-comment', function(comment) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è —ç—Ç–æ–π –∫–Ω–∏–≥–∏
            if (comment.bookId === bookId || comment.bookId === String(bookId)) {
                console.log('‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ UI');
                addCommentToUI(comment);
            } else {
                console.log('‚ùå –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –¥—Ä—É–≥–æ–π –∫–Ω–∏–≥–∏, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º');
            }
        });

        socket.emit('request-comments');
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initComments);
    } else {
        initComments();
    }
</script>